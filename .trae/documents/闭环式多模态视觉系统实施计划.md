# 闭环式多模态视觉系统实施计划

根据您的要求，我将基于 `闭环式多模态视觉系统完整实施计划.md`，在 `f:\2_study\-200_StudyPace\Code\python\计算机视觉\VL\结课作业` 目录下实施该项目。

## 1. 项目配置与环境搭建
- **创建配置文件 `code/config.py`**：
  - 配置项目根目录、数据目录、结果目录。
  - 加载 `.env` 文件中的 `DASHSCOPE_API_KEY`。
  - 设置模型参数：基础模型统一使用 `qwen3-vl-8b`（注意：若API不支持该特定名称，将回退到兼容的 `qwen-vl-max` 或用户指定版本）。
  - 配置实验参数（迭代次数、阈值等）。

## 2. 核心模型模块开发
- **Qwen3-VL 推理模块 (`code/model_qwen.py`)**：
  - 封装 DashScope API 调用。
  - 实现多轮对话接口，支持传入图片和文本。
  - 实现基于提示工程的证据定位功能。
- **SAM2 分割模块 (`code/model_sam2.py`)**：
  - 封装 SAM2 模型加载与推理。
  - 实现基于文本提示（Box/Point）的分割。
  - 实现 Mask 提取与图像裁剪功能。
- **CLIP 验证模块 (`code/model_clip.py`)**：
  - 加载 CLIP 模型（使用 `transformers` 库）。
  - 实现图像-文本相似度计算，用于验证分割出的区域与问题的相关性。

## 3. 闭环控制系统实现
- **主闭环控制器 (`code/main_loop.py`)**：
  - 实现 `Qwen -> SAM -> CLIP -> Qwen` 的完整闭环流程。
  - **流程逻辑**：
    1. Qwen 分析问题，提出需要观察的目标。
    2. SAM 根据目标描述分割图像。
    3. CLIP 验证分割区域与问题的相关性。
    4. 将高置信度的视觉证据回馈给 Qwen 进行最终推理。
  - 集成迭代控制（最大迭代轮数、提前停止机制）。

## 4. 评测与实验系统
- **基础评估 (`code/evaluation.py`)**：
  - 加载 `data/images/metadata.json` 和 VQA 数据。
  - 实现精确匹配 (EM) 和模糊匹配评估指标。
- **可靠性评测 (`code/reliability.py`)**：
  - 实现 OOD (Out-of-Distribution) 泛化测试。
  - 实现长尾/小目标分桶分析。
- **效率分析 (`code/efficiency.py`)**：
  - 统计推理耗时、Token 消耗、工具调用次数。
- **消融实验 (`code/ablation.py`)**：
  - 对比开启/关闭闭环、开启/关闭 CLIP 验证的效果。

## 5. 结果管理与报告
- **结果保存**：
  - 确保所有脚本将结果输出至 `results/` 目录，按时间戳归档。
- **可视化 (`code/visualization.py`)**：
  - 完善现有可视化脚本，支持闭环过程的可视化（如展示中间分割结果）。
- **实验报告 (`code/report.py`)**：
  - 自动汇总实验数据，生成实验报告草稿。

## 6. 代码规范与文档
- 遵循 PEP8 规范，添加全中文注释和文档字符串。
- 确保所有文件路径严格遵循用户指定结构。

---

**待确认事项**：
- 关于 `qwen3-vl-8b`：目前 DashScope API 主要提供 `qwen-vl-max`, `qwen-vl-plus` 等。如果 `qwen3-vl-8b` 是特定部署版本或新模型名，请确保环境支持；否则我将在配置中预留修改接口，默认尝试连接。
- 依赖库：将假设环境中已安装 `dashscope`, `torch`, `transformers`, `Pillow`, `opencv-python` 等必要库。

请确认以上计划，我将开始编写代码。