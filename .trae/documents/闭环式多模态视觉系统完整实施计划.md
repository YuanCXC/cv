# 闭环式多模态视觉系统与可靠性评测 - 完整实施计划

## 一、项目现状分析

**已有代码**：
- `src/vqa_common.py` (1125行) - 公共功能模块
- `src/1_vqa_evaluation.py` (251行) - 基线VQA评估
- `src/1_vqa_evaluation_with_clip.py` (602行) - VQA+CLIP消融实验
- `src/2_vqa_rerank.py` (109行) - CLIP重排序
- `config.py` - 配置文件

**数据集**：200张图片 + metadata.json（200条VQA数据）

**缺失部分**：
1. ❌ SAM/SAM2分割模型（论文硬性要求）
2. ❌ 闭环系统架构（Qwen3-VL → SAM → CLIP → Qwen3-VL）
3. ❌ OOD泛化评测
4. ❌ 长尾/小目标分析
5. ❌ 效率/成本分析（推理时间、显存、工具调用次数）
6. ❌ 失败案例分类统计
7. ❌ 加速策略实现

---

## 二、完整实施计划

### 阶段1：模型模块开发（约400行）

**1.1 SAM2分割模块 (`code/model_sam2.py`)**
- SAM2模型初始化和加载
- 基于文本提示的分割函数
- 基于点提示的分割函数
- Mask后处理和优化
- 分割结果可视化

**1.2 CLIP验证模块 (`code/model_clip.py`)**
- CLIP模型初始化
- 图像-文本相似度计算
- 候选答案评分排序
- 批量相似度计算优化

**1.3 Qwen3-VL推理模块 (`code/model_qwen.py`)**
- Qwen3-VL客户端初始化
- VQA推理函数
- 证据定位提示工程
- 多轮对话支持

### 阶段2：闭环系统实现（约500行）

**2.1 主闭环控制器 (`code/main_loop.py`)**
```
完整闭环流程：
1. Qwen3-VL分析问题，定位需要分割的区域
2. 调用SAM2进行目标分割（生成多个候选mask）
3. 裁剪mask区域，提取证据图像
4. 使用CLIP验证证据与问题的相关性
5. 将证据回喂给Qwen3-VL进行细化推理
6. 迭代优化（最多3轮）
7. 输出最终答案+证据区域
```

**2.2 迭代控制机制**
- 提前停止条件（置信度>0.9或答案稳定）
- 失败率随迭代统计
- 平均迭代次数计算

**2.3 证据追踪系统**
- 记录每轮迭代的SAM调用次数
- 记录CLIP计算次数
- 记录Qwen3-VL调用次数
- 记录推理时间和显存占用

### 阶段3：评测系统（约400行）

**3.1 基础评估 (`code/evaluation.py`)**
- 精确匹配（EM）
- 模糊匹配
- 证据命中率计算
- 成本指标计算

**3.2 可靠性评测 (`code/reliability.py`)**
- OOD泛化测试（使用风格扰动数据）
- 长尾/小目标分桶分析
  - 按目标面积分桶：small(<32²), medium(32²-96²), large(>96²)
  - 按类别频次分桶统计

**3.3 效率分析 (`code/efficiency.py`)**
- 推理时间统计（每图/每问）
- 峰值显存监控
- 工具调用次数统计
- 加速策略对比：
  - 策略1：特征缓存
  - 策略2：mask复用
  - 策略3：batch推理

**3.4 失败归因 (`code/error_analysis.py`)**
- 失败类型分类：
  - 读图失败
  - 定位失败
  - 推理失败
  - 幻觉
- 生成失败案例分类统计表
- 每类至少3个图例

### 阶段4：消融实验（约300行）

**4.1 消融实验设计 (`code/ablation.py`)**
- 消融1：无闭环（one-shot）vs 有闭环（loop）
- 消融2：无验证器（只看CLIP）vs 有验证器（CLIP+VLM自检）
- 消融3：迭代上限1/2/3的trade-off
- 消融4：OOD条件下one-shot与loop的差距

**4.2 置信区间计算**
- 对关键指标做95%置信区间
- 或固定数据划分下重复3次不同随机种子

### 阶段5：可视化与报告（约300行）

**5.1 可视化模块 (`code/visualization.py`)**
- 闭环流程图
- 性能对比图
- 消融实验对比图
- 失败案例可视化
- 效率分析图

**5.2 实验报告生成 (`code/report.py`)**
- 完整实验报告（8-12页PDF）
- 包含所有要求章节：
  - 摘要、引言、相关工作（≥10篇引用）
  - 方法（含系统流程图/算法框）
  - 实验设置、结果、消融
  - 鲁棒性评测、效率评测
  - 误差分析、局限与伦理、可复现清单

### 阶段6：工具与配置（约100行）

**6.1 工具函数 (`code/utils.py`)**
- 图像加载和预处理
- 元数据解析
- 结果保存和格式化
- 日志记录

**6.2 配置管理 (`code/config.py`)**
- 路径配置
- 模型配置
- 实验参数
- 加速策略开关


---

## 四、实验执行计划

### 实验1：基线评估（one-shot）
- 运行 `code/evaluation.py`
- 输出：准确率、EM、成本指标
- 保存到 `results/baseline/`

### 实验2：闭环系统评估
- 运行 `code/main_loop.py`
- 统计：迭代次数、失败率、提前停止率
- 输出：答案+证据区域
- 保存到 `results/loop/`

### 实验3：消融实验（4组）
- 运行 `code/ablation.py`
- 生成消融对比图表
- 保存到 `results/ablation/`

### 实验4：可靠性评测
- 运行 `code/reliability.py`
- OOD泛化测试（风格扰动）
- 长尾/小目标分桶分析
- 保存到 `results/reliability/`

### 实验5：效率分析
- 运行 `code/efficiency.py`
- 对比加速策略效果
- 生成效率分析图表
- 保存到 `results/efficiency/`

### 实验6：失败归因
- 运行 `code/error_analysis.py`
- 生成失败案例分类统计表
- 可视化失败案例
- 保存到 `results/error_analysis/`

---

## 五、论文撰写计划

### 论文结构（8-12页）

1. **摘要**（1页）
   - 研究背景、方法、主要结果、贡献

2. **引言**（1页）
   - VQA挑战、闭环系统必要性、本文贡献

3. **相关工作**（1.5页，≥10篇引用）
   - VQA方法综述
   - 多模态融合方法
   - 闭环推理方法

4. **方法**（2页）
   - 系统架构图
   - 算法流程框
   - 闭环机制设计
   - 加速策略

5. **实验设置**（1页）
   - 数据集描述
   - 评估指标
   - 实验环境

6. **结果**（1.5页）
   - 主实验结果
   - 消融实验结果
   - 可靠性评测结果

7. **消融实验**（1页）
   - 4组消融实验对比
   - 置信区间

8. **鲁棒性评测**（0.5页）
   - OOD泛化结果
   - 长尾/小目标分析

9. **效率评测**（0.5页）
   - 推理时间对比
   - 显存占用对比
   - 加速策略效果

10. **误差分析**（0.5页）
    - 失败案例分类统计表
    - 典型失败案例分析

11. **局限与伦理**（0.5页）
    - 方法局限性
    - 伦理考虑

12. **可复现清单**（0.5页）
    - 代码链接
    - 数据链接
    - 环境配置

---

## 六、质量保证措施

1. **代码质量**
   - 完整注释（函数功能、参数、算法原理）
   - 模块化设计
   - 变量命名规范
   - 总代码量控制在2000行以内

2. **实验可重复性**
   - 固定随机种子
   - 详细实验日志
   - 环境配置记录

3. **文档规范性**
   - 图表标注清晰
   - 表格格式统一
   - 引用格式规范

---

## 七、预计交付物

✅ **代码包**（约2000行）
- 12个Python模块
- 完整注释
- 可直接运行

✅ **实验结果**
- 6组实验结果
- 完整数据记录
- 可视化图表

✅ **论文PDF**（8-12页）
- 完整章节结构
- ≥10篇引用
- 系统流程图

✅ **GitHub仓库**
- 代码托管
- README说明
- License声明
